---
name: Bluefin Wallpapers
on:
  workflow_dispatch:

jobs:
  create-release:
    name: Create Release for Bluefin Wallpapers with Plasma Dynamic Wallpaper support
    runs-on: ubuntu-latest
    permissions:
      contents: write
    # We need a newish version of kimageformats, 24.04 doesn't have it
    container: docker.io/library/ubuntu:25.04@sha256:103c7471649a4fd9996fe73dff20f46082e4e0f0f6240c91954b8b09c38b6faf

    steps:

      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6
        with:
          fetch-depth: 0
      - name: Create tarballs
        shell: bash
        run: |
          # Create separate archives for each platform
          mkdir -p output/packaging/macos
          mkdir -p output/packaging/kde
          mkdir -p output/packaging/gnome
          mkdir -p output/packaging/png
          
          # macOS: HEIC dynamic wallpapers
          cp -R wallpapers/bluefin/macos/*.heic output/packaging/macos/
          cd output/packaging/macos && tar -acvf ../bluefin-wallpapers-macos.tar.zstd *.heic && cd -
          
          # KDE: AVIF wallpapers
          cp wallpapers/bluefin/kde-support/*.avif output/packaging/kde/
          cd output/packaging/kde && tar -acvf ../bluefin-wallpapers-kde.tar.zstd *.avif && cd -
          
          # GNOME: JXL wallpapers + XML metadata
          cp -R wallpapers/bluefin/images/*.jxl output/packaging/gnome/
          cp -R wallpapers/bluefin/images/*.xml output/packaging/gnome/
          cp -R wallpapers/bluefin/gnome-background-properties output/packaging/gnome/
          cd output/packaging/gnome && tar -acvf ../bluefin-wallpapers-gnome.tar.zstd * && cd -
          
          # PNG: For other desktops (Hyprland, Niri, Sway, etc.)
          cp -R wallpapers/bluefin/png/*.png output/packaging/png/
          cd output/packaging/png && tar -acvf ../bluefin-wallpapers-png.tar.zstd *.png && cd -

      - name: Determine tag
        id: tag
        run: echo "tag=bluefin-v$(date --iso-8601=date)" >> "$GITHUB_OUTPUT"

      - name: Publish release
        uses: ncipollo/release-action@b7eabc95ff50cbeeedec83973935c8f306dfcd0b # v1
        with:
          tag:   ${{ steps.tag.outputs.tag }}
          allowUpdates: false
          name:  "${{ steps.tag.outputs.tag }}"
          artifacts: "output/packaging/bluefin-wallpapers-*.tar.zstd"
          token: ${{ secrets.GITHUB_TOKEN }}
